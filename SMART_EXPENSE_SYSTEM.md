# ğŸ¤– æ™ºèƒ½è¨˜å¸³ç³»çµ±è¨­è¨ˆæ–‡ä»¶

## ğŸ“‹ ç›®æ¨™

æ‰“é€ æœ€ä½³ UX çš„ LINE è¨˜å¸³ç³»çµ±ï¼Œæ”¯æ´ï¼š
1. **æ‡¶äººæ¨¡å¼**ï¼šæ¥µç°¡æŒ‡ä»¤ï¼Œ1 ç§’è¨˜å¸³
2. **ç²¾ç´°æ¨¡å¼**ï¼šè©³ç´°åˆ†é¡ï¼Œä¾¿æ–¼åˆ†æ
3. **æ™ºèƒ½å­¸ç¿’**ï¼šè‡ªå‹•è­˜åˆ¥é—œéµå­—
4. **æ‰¹æ¬¡è¨˜å¸³**ï¼šä¸€æ¬¡è¨˜å¤šç­†

---

## ğŸ¯ æŒ‡ä»¤æ ¼å¼

### æ‡¶äººæ¨¡å¼
```
è¨˜ 100              â†’ è‡ªå‹•æ­¸é¡ç‚ºã€Œé£²é£Ÿã€
è¨˜ 100 äº¤é€š         â†’ æŒ‡å®šå¤§åˆ†é¡
è¨˜ 100 åˆé¤         â†’ æ™ºèƒ½è­˜åˆ¥ç‚ºã€Œé£²é£Ÿã€ï¼Œå‚™è¨»ã€Œåˆé¤ã€
```

### ç²¾ç´°æ¨¡å¼
```
è¨˜ 100 ä¸‹åˆèŒ¶       â†’ åˆ†é¡ã€Œé£²é£Ÿã€ï¼Œå­åˆ†é¡ã€Œä¸‹åˆèŒ¶ã€
è¨˜ 100 é£²é£Ÿ ä¸‹åˆèŒ¶ æ˜Ÿå·´å…‹  â†’ åˆ†é¡ã€Œé£²é£Ÿã€ï¼Œå­åˆ†é¡ã€Œä¸‹åˆèŒ¶ã€ï¼Œå‚™è¨»ã€Œæ˜Ÿå·´å…‹ã€
```

### æ‰¹æ¬¡è¨˜å¸³
```
è¨˜ 100 æ—©é¤
è¨˜ 50 å’–å•¡
è¨˜ 300 åˆé¤
è¨˜ 80 ä¸‹åˆèŒ¶
```

---

## ğŸ§  æ™ºèƒ½è­˜åˆ¥æµç¨‹

```
ç”¨æˆ¶è¼¸å…¥: è¨˜ 100 ä¸‹åˆèŒ¶
    â†“
1. è§£æé‡‘é¡: 100
2. æå–é—œéµå­—: ä¸‹åˆèŒ¶
    â†“
3. æŸ¥è©¢ç”¨æˆ¶è‡ªå®šç¾©æ˜ å°„
   â””â”€ æœ‰ â†’ ä½¿ç”¨ç”¨æˆ¶è¨­å®š (confidence: high)
   â””â”€ ç„¡ â†“
4. æŸ¥è©¢ç³»çµ±é è¨­æ˜ å°„
   â””â”€ æœ‰ â†’ ä½¿ç”¨é è¨­ (confidence: medium)
   â””â”€ ç„¡ â†“
5. ç„¡æ³•è­˜åˆ¥ (confidence: low)
   â””â”€ è©¢å•ç”¨æˆ¶ç¢ºèª
    â†“
6. ç”¨æˆ¶ç¢ºèªå¾Œï¼Œå­¸ç¿’ä¸¦å­˜å…¥è³‡æ–™åº«
    â†“
7. ä¸‹æ¬¡è‡ªå‹•è­˜åˆ¥
```

---

## ğŸ“Š è³‡æ–™åº«è¨­è¨ˆ

### KeywordMapping è¡¨
```sql
CREATE TABLE keyword_mappings (
  id          String  PRIMARY KEY,
  userId      String  NOT NULL,
  keyword     String  NOT NULL,     -- å¦‚ï¼šä¸‹åˆèŒ¶ã€æ˜Ÿå·´å…‹
  category    String  NOT NULL,     -- å¦‚ï¼šé£²é£Ÿ
  subcategory String  NULL,         -- å¦‚ï¼šä¸‹åˆèŒ¶
  isDefault   Boolean DEFAULT false,
  usageCount  Int     DEFAULT 0,    -- ä½¿ç”¨æ¬¡æ•¸ï¼ˆå„ªå…ˆç´šï¼‰
  createdAt   DateTime,
  updatedAt   DateTime,

  UNIQUE(userId, keyword)
);
```

### é è¨­é—œéµå­—æ˜ å°„ï¼ˆç³»çµ±å…§å»ºï¼‰
```typescript
{
  ä¸‹åˆèŒ¶: ['ä¸‹åˆèŒ¶', 'å’–å•¡', 'èŒ¶', 'æ˜Ÿå·´å…‹', 'cama', '85åº¦c'],
  é›¶é£Ÿ: ['é›¶é£Ÿ', 'é¤…ä¹¾', 'ç³–æœ', 'æ´‹èŠ‹ç‰‡'],
  å®µå¤œ: ['å®µå¤œ', 'æ¶ˆå¤œ', 'å¤œå¸‚', 'é¹½é…¥é›'],
  è¨ˆç¨‹è»Š: ['uber', 'taxi', 'è¨ˆç¨‹è»Š'],
  // ... æ›´å¤š
}
```

---

## ğŸ’¬ å°è©±æµç¨‹ç¯„ä¾‹

### æƒ…å¢ƒ 1ï¼šæ™ºèƒ½è­˜åˆ¥æˆåŠŸ
```
ç”¨æˆ¶: è¨˜ 100 ä¸‹åˆèŒ¶
Bot:  âœ… å·²è¨˜å¸³
      ğŸ’° é‡‘é¡: $100
      ğŸ“ åˆ†é¡: é£²é£Ÿ > ä¸‹åˆèŒ¶
```

### æƒ…å¢ƒ 2ï¼šéœ€è¦ç¢ºèª
```
ç”¨æˆ¶: è¨˜ 100 ç‹å“
Bot:  æˆ‘è­˜åˆ¥åˆ°ï¼š
      ğŸ’° é‡‘é¡: $100
      ğŸ“ é—œéµå­—: ç‹å“
      ğŸ“ å»ºè­°åˆ†é¡: é£²é£Ÿ

      é€™æ¨£åˆ†é¡æ­£ç¢ºå—ï¼Ÿ
      âœ… å›è¦†ã€Œæ˜¯ã€ç¢ºèª
      âŒ å›è¦†ã€Œå¦ã€é‡æ–°é¸æ“‡

ç”¨æˆ¶: æ˜¯
Bot:  âœ… å·²è¨˜å¸³ä¸¦å­¸ç¿’ï¼
      ä¸‹æ¬¡ã€Œç‹å“ã€æœƒè‡ªå‹•æ­¸é¡ç‚ºã€Œé£²é£Ÿã€
```

### æƒ…å¢ƒ 3ï¼šé‡æ–°é¸æ“‡åˆ†é¡
```
ç”¨æˆ¶: è¨˜ 100 ç‹å“
Bot:  å»ºè­°åˆ†é¡: é£²é£Ÿ
      æ­£ç¢ºå—ï¼Ÿ

ç”¨æˆ¶: å¦
Bot:  è«‹é¸æ“‡ã€Œç‹å“ã€çš„åˆ†é¡ï¼š
      1ï¸âƒ£ é£²é£Ÿ
      2ï¸âƒ£ äº¤é€š
      3ï¸âƒ£ å±…ä½
      4ï¸âƒ£ å¨›æ¨‚
      5ï¸âƒ£ è³¼ç‰©
      6ï¸âƒ£ é†«ç™‚
      7ï¸âƒ£ æŠ•è³‡
      8ï¸âƒ£ å…¶ä»–

ç”¨æˆ¶: 4
Bot:  âœ… å·²è¨˜å¸³ä¸¦å­¸ç¿’ï¼
      ä¸‹æ¬¡ã€Œç‹å“ã€æœƒè‡ªå‹•æ­¸é¡ç‚ºã€Œå¨›æ¨‚ã€
```

### æƒ…å¢ƒ 4ï¼šæ‰¹æ¬¡è¨˜å¸³
```
ç”¨æˆ¶: è¨˜ 100 æ—©é¤
      è¨˜ 50 å’–å•¡
      è¨˜ 300 åˆé¤

Bot:  ğŸ“‹ æ‰¹æ¬¡è¨˜å¸³ç¢ºèªï¼š

      1. $100 - é£²é£Ÿ
      2. $50 - é£²é£Ÿ > ä¸‹åˆèŒ¶
      3. $300 - é£²é£Ÿ

      å…± 3 ç­†äº¤æ˜“
      âœ… å›è¦†ã€Œç¢ºèªã€é€å‡º
      âŒ å›è¦†ã€Œå–æ¶ˆã€æ”¾æ£„

ç”¨æˆ¶: ç¢ºèª
Bot:  âœ… å·²è¨˜å¸³ 3 ç­†äº¤æ˜“
```

---

## ğŸ”§ æŠ€è¡“å¯¦ä½œ

### 1. è§£æå™¨æœå‹™ (expenseParserService.ts)
- `parseExpenseCommand()` - è§£æå–®ç­†æŒ‡ä»¤
- `parseBatchExpenseCommands()` - è§£ææ‰¹æ¬¡æŒ‡ä»¤
- `recognizeKeywords()` - æ™ºèƒ½è­˜åˆ¥é—œéµå­—
- `learnKeyword()` - å­¸ç¿’æ–°é—œéµå­—

### 2. å°è©±ç®¡ç†æœå‹™ (conversationService.ts)
- `getConversationState()` - å–å¾—å°è©±ç‹€æ…‹
- `setConversationState()` - è¨­å®šå°è©±ç‹€æ…‹
- è™•ç†å¤šè¼ªå°è©±æµç¨‹

### 3. Webhook Controller æ•´åˆ
- æ¥æ”¶ LINE è¨Šæ¯
- èª¿ç”¨è§£æå™¨
- æ ¹æ“šä¿¡å¿ƒåº¦æ±ºå®šæ˜¯å¦éœ€è¦ç¢ºèª
- è™•ç†ç”¨æˆ¶ç¢ºèªå›æ‡‰
- èª¿ç”¨ createTransaction å„²å­˜

---

## ğŸ“ˆ å„ªåŒ–ç­–ç•¥

### 1. ä½¿ç”¨æ¬¡æ•¸å„ªå…ˆ
```typescript
// å¦‚æœç”¨æˆ¶å¤šæ¬¡å°‡ã€Œæ˜Ÿå·´å…‹ã€æ­¸é¡ç‚ºã€Œå¨›æ¨‚ã€
// usageCount æœƒå¢åŠ ï¼Œå„ªå…ˆç´šæé«˜
```

### 2. æ¨¡ç³ŠåŒ¹é…
```typescript
// "æ˜Ÿå·´" ä¹Ÿèƒ½åŒ¹é… "æ˜Ÿå·´å…‹"
keyword.contains(userInput, mode: 'insensitive')
```

### 3. å¿«é€Ÿè¨˜å¸³å»ºè­°
```typescript
// åˆ†æç”¨æˆ¶è¨˜å¸³ç¿’æ…£ï¼Œåœ¨ç‰¹å®šæ™‚é–“æä¾›å»ºè­°
// ä¾‹å¦‚ï¼šä¸­åˆ12é» â†’ å»ºè­°è¨˜éŒ„åˆé¤
```

---

## ğŸ¨ ç¶²é ç«¯æ•´åˆ

### åˆ†é¡é¡¯ç¤º
```tsx
// Ledger.tsx é¡¯ç¤º
<div>
  <span>åˆ†é¡: {category}</span>
  {subcategory && <span> > {subcategory}</span>}
  {note && <span className="text-gray"> ({note})</span>}
</div>
```

### é—œéµå­—ç®¡ç†
```tsx
// æ–°å¢é é¢ï¼šé—œéµå­—ç®¡ç†
// ç”¨æˆ¶å¯ä»¥æŸ¥çœ‹/ç·¨è¼¯/åˆªé™¤è‡ªå·±çš„é—œéµå­—æ˜ å°„
<KeywordMappingManager />
```

---

## âœ… å¯¦ä½œæª¢æŸ¥æ¸…å–®

- [x] è¨­è¨ˆè³‡æ–™åº« Schema
- [x] å¯¦ä½œè§£æå™¨æœå‹™
- [x] å¯¦ä½œå°è©±ç®¡ç†æœå‹™
- [ ] æ›´æ–° Webhook Controller
- [ ] æ•´åˆ createTransaction API
- [ ] åŸ·è¡Œè³‡æ–™åº«é·ç§»
- [ ] æ¸¬è©¦å„ç¨®æƒ…å¢ƒ
- [ ] éƒ¨ç½²åˆ° Render

---

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

1. **è³‡æ–™åº«é·ç§»**
```bash
cd server
npx prisma migrate dev --name add_keyword_mapping
npx prisma generate
```

2. **ç·¨è­¯**
```bash
npm run build
```

3. **æ¸¬è©¦**
```bash
# æ¸¬è©¦å„ç¨®è¨˜å¸³æŒ‡ä»¤
è¨˜ 100
è¨˜ 100 ä¸‹åˆèŒ¶
è¨˜ 100 é£²é£Ÿ ä¸‹åˆèŒ¶ æ˜Ÿå·´å…‹
```

4. **éƒ¨ç½²**
```bash
git add .
git commit -m "feat: æ™ºèƒ½è¨˜å¸³ç³»çµ± - æ”¯æ´é—œéµå­—å­¸ç¿’èˆ‡æ‰¹æ¬¡è¨˜å¸³"
git push
```
