// Prisma Schema for SmartCapital LINE Bot
// Database: SQLite (development) / PostgreSQL (production)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ç”¨æˆ¶è¡¨ - å„²å­˜ LINE ç”¨æˆ¶åŸºæœ¬è³‡æ–™
model User {
  id          String  @id @default(cuid())
  lineUserId  String  @unique
  displayName String?
  bankroll    Float   @default(10000) // é è¨­æœ¬é‡‘ $10,000

  // ğŸ¯ æŠ•è³‡ç¯„åœè¨­å®šï¼ˆæ¼¸é€²å¼æ­éœ²ï¼‰
  enableTWStock Boolean @default(true) // å°è‚¡
  enableUSStock Boolean @default(false) // ç¾è‚¡
  enableCrypto  Boolean @default(false) // åŠ å¯†è²¨å¹£

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions    Transaction[]
  assets          Asset[]
  accounts        Account[] // æ–°å¢ï¼šå¸³æˆ¶é—œè¯
  transfers       Transfer[] // æ–°å¢ï¼šè½‰å¸³è¨˜éŒ„
  settings        UserSettings?
  notifications   Notification[]
  priceAlerts     PriceAlert[] // æ–°å¢ï¼šåƒ¹æ ¼è­¦ç¤º
  keywordMappings KeywordMapping[] // æ–°å¢ï¼šé—œéµå­—æ˜ å°„

  @@map("users")
}

// ğŸ¦ å¸³æˆ¶è¡¨ - è³‡é‡‘æ± ç®¡ç†ï¼ˆéŠ€è¡Œã€è­‰åˆ¸æˆ¶ã€ç¾é‡‘ï¼‰
model Account {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String // "å°æ–°éŠ€è¡Œ", "åœ‹æ³°è¤‡å§”è¨—", "Firstrade"
  type      String // "CASH" | "BANK" | "BROKERAGE" | "EXCHANGE"
  currency  String  @default("TWD") // "TWD" | "USD" | "USDT"
  balance   Float   @default(0)
  isDefault Boolean @default(false) // é è¨­å¸³æˆ¶
  isSub     Boolean @default(false) // æ˜¯å¦ç‚ºè¤‡å§”è¨—

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // é—œè¯
  transactions   Transaction[]
  transfersFrom  Transfer[]    @relation("FromAccount")
  transfersTo    Transfer[]    @relation("ToAccount")
  transactionsTo Transaction[] @relation("TransferTarget") // è½‰å¸³ç›®æ¨™

  @@index([userId, type])
  @@map("accounts")
}

// ğŸ’¸ è½‰å¸³è¨˜éŒ„è¡¨
model Transfer {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  fromAccountId String
  fromAccount   Account @relation("FromAccount", fields: [fromAccountId], references: [id])

  toAccountId String
  toAccount   Account @relation("ToAccount", fields: [toAccountId], references: [id])

  amount       Float
  exchangeRate Float? // è·¨å¹£åˆ¥åŒ¯ç‡
  fee          Float? // æ‰‹çºŒè²»
  note         String?
  date         DateTime @default(now())

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([fromAccountId])
  @@index([toAccountId])
  @@map("transfers")
}

// äº¤æ˜“è¨˜éŒ„è¡¨ - ç”Ÿæ´»è¨˜å¸³ï¼ˆå·²æ•´åˆå¸³æˆ¶ç³»çµ±ï¼‰
model Transaction {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date     DateTime @default(now())
  type     String // "income" | "expense" | "transfer" | "invest"
  amount   Float
  category String // é£²é£Ÿã€äº¤é€šã€å±…ä½ã€æŠ•è³‡ç­‰
  note     String?

  // ğŸ¦ è³‡é‡‘ä¾†æº/ç›®æ¨™å¸³æˆ¶ï¼ˆå¯é¸ï¼Œå‘å¾Œå…¼å®¹ï¼‰
  accountId String?
  account   Account? @relation(fields: [accountId], references: [id])

  // å¦‚æœæ˜¯è½‰å¸³ï¼Œéœ€è¦ç›®æ¨™å¸³æˆ¶
  toAccountId String?
  toAccount   Account? @relation("TransferTarget", fields: [toAccountId], references: [id])

  // ğŸ’± å¤šå¹£åˆ¥æ”¯æ´
  originalCurrency String? // åŸå§‹äº¤æ˜“å¹£åˆ¥
  exchangeRate     Float? // å¦‚æœæœ‰æ›åŒ¯

  createdAt DateTime @default(now())

  @@index([userId, date])
  @@index([accountId])
  @@map("transactions")
}

// è³‡ç”¢æŒå€‰è¡¨ - æŠ•è³‡è¨˜éŒ„ï¼ˆå·²æ•´åˆå¤šå¹£åˆ¥ï¼‰
model Asset {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  symbol   String // TSLA, BTC, 2330.TW ç­‰
  name     String? // Tesla Inc., Bitcoin
  type     String // "Stock" | "Crypto" | "ETF"
  quantity Float
  avgPrice Float // å¹³å‡è²·å…¥åƒ¹

  // ğŸ’± å¤šå¹£åˆ¥æ”¯æ´
  currency        String @default("TWD") // "TWD" | "USD" | "USDT"
  avgCurrency     String @default("TWD") // æˆæœ¬è¨ˆç®—å¹£åˆ¥
  currentCurrency String @default("TWD") // ç•¶å‰å¸‚å€¼å¹£åˆ¥

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, symbol])
  @@index([userId])
  @@index([userId, type])
  @@map("assets")
}

// ç”¨æˆ¶ç­–ç•¥åƒæ•¸è¨­å®š
model UserSettings {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // å‡±åˆ©å…¬å¼åƒæ•¸
  kellyWinProbability Float @default(55.0) // é è¨­å‹ç‡ 55%
  kellyOdds           Float @default(2.0) // é è¨­è³ ç‡ 1:1 (2.0)

  // é¦¬ä¸æ ¼çˆ¾åƒæ•¸
  martingaleMultiplier Float @default(2.0) // é è¨­å€æ•¸ 2x

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_settings")
}

// å°è©±ç‹€æ…‹è¡¨ - è¿½è¹¤ç”¨æˆ¶ç•¶å‰æ“ä½œç‹€æ…‹ (ä¾‹å¦‚ç­‰å¾…è¼¸å…¥è‚¡æ•¸)
model ConversationState {
  id         String @id @default(cuid())
  lineUserId String @unique

  state   String // "IDLE" | "WAITING_EXPENSE_CATEGORY" | "WAITING_BUY_QUANTITY" | "WAITING_SELL_PRICE"
  context String? // JSON æ ¼å¼ï¼Œå„²å­˜è‡¨æ™‚è³‡æ–™ (ä¾‹å¦‚ {"symbol": "TSLA", "price": 240.5})

  updatedAt DateTime @updatedAt

  @@map("conversation_states")
}

// é€šçŸ¥è¡¨ - å„²å­˜ç³»çµ±é€šçŸ¥å’Œè­¦å ±
model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    String // "info" | "alert" | "success"
  title   String
  message String
  read    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, read, createdAt])
  @@map("notifications")
}

// åƒ¹æ ¼è­¦ç¤ºè¡¨ - å„²å­˜ç”¨æˆ¶è¨­å®šçš„è‚¡ç¥¨åƒ¹æ ¼è­¦ç¤º
model PriceAlert {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  symbol String // è‚¡ç¥¨ä»£è™Ÿ (2330.TW, TSLA, etc.)
  name   String? // è‚¡ç¥¨åç¨±

  // è­¦ç¤ºé¡å‹
  // DAILY_CHANGE: å–®æ—¥æ¼²è·Œè¶…é X%
  // PROFIT_LOSS: ç´¯è¨ˆç²åˆ©/è™§æè¶…é X%
  // STOP_PROFIT: åœåˆ©é»
  // STOP_LOSS: åœæé»
  // TARGET_PRICE: ç›®æ¨™åƒ¹
  alertType String

  // æ¢ä»¶è¨­å®š
  threshold   Float? // ç™¾åˆ†æ¯”é–¾å€¼ (ä¾‹å¦‚ 5.0 ä»£è¡¨ 5%)
  targetPrice Float? // ç›®æ¨™åƒ¹æ ¼
  direction   String? // "UP" | "DOWN" | "BOTH" (for DAILY_CHANGE)

  // åƒè€ƒåƒ¹æ ¼ï¼ˆç”¨æ–¼è¨ˆç®—ç´¯è¨ˆç²åˆ©/è™§æï¼‰
  referencePrice Float? // è²·å…¥å‡åƒ¹

  // ç‹€æ…‹
  isActive      Boolean   @default(true)
  lastTriggered DateTime?
  triggerCount  Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([symbol])
  @@index([userId, symbol, isActive])
  @@map("price_alerts")
}

// é—œéµå­—æ˜ å°„è¡¨ - æ™ºèƒ½è­˜åˆ¥ç”¨
model KeywordMapping {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  keyword     String // é—œéµå­—ï¼ˆå¦‚ï¼šä¸‹åˆèŒ¶ã€æ˜Ÿå·´å…‹ã€Uberï¼‰
  category    String // å°æ‡‰çš„åˆ†é¡ï¼ˆé£²é£Ÿã€äº¤é€šç­‰ï¼‰
  subcategory String? // å­åˆ†é¡ï¼ˆå¯é¸ï¼‰

  // å­¸ç¿’ä¾†æº
  isDefault  Boolean @default(false) // æ˜¯å¦ç‚ºç³»çµ±é è¨­
  usageCount Int     @default(0) // ä½¿ç”¨æ¬¡æ•¸ï¼ˆç”¨æ–¼å„ªåŒ–åŒ¹é…å„ªå…ˆç´šï¼‰

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, keyword])
  @@index([userId, keyword])
  @@index([keyword])
  @@map("keyword_mappings")
}
